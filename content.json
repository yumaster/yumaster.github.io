[{"title":"说到加载图片，我们可以谈些什么","date":"2017-07-28T02:20:00.000Z","path":"2017/07/28/img-lazy-load/","text":"其实，一开始让我在网页中加载一张图片，我是，是拒绝的…因为实在太简单了。 &lt;img src=&quot;xx.jpg&quot; /&gt;是每个前端开发都会的技能。然而，如果你想做到极致，事情还没有这么简单。 最近实现了个图片加载器，用于大型web前端项目中，关于加载图片这一话题，仔细想来可以加许多的特技。 ###第一步：滚屏加载 这是最容易想到的点，也是一开始就准备做的。 随web体验的进步，滚屏加载代替分页加载的情形越来越多。也就是先预留图片位置，而不去加载图片，直到这个预留区域滚动到屏幕中，用户能看见了，才去加载图片。如此一来，有“按需加载”的意味，由于图片加载延后，不抢占带宽，在打开页面的首屏会快很多。我们称之为“懒加载(lazyload)”。 其实现也很简单，在html里面写&lt;img lazy-src=&quot;xx.jpg&quot; /&gt;，然后用js去判断这个节点是否出现在屏幕中，如果是，则取出lazy-src属性，赋值成&lt;img lazy-src=&quot;xx.jpg&quot; src=&quot;xx.jpg&quot;/&gt;，触发此节点onload，这就实现最简单的滚屏加载了。 ###第二步：特殊状态处理 特殊状态有两种：加载中与加载失败。这两种情况的处理逻辑相类似，拿加载中的逻辑做例子。 图片触发加载，到图片加载完成（或失败）之间，肯定会有一段时间。不做处理的话，用户在等待的过程中，就只能看到空白的区域，非常的奇怪。在低网速，以及用户非常快的拉滚动条的情形下，这种现象将更加明显。 那么在触发onload之前，就需要补一些逻辑，展示对应的loading图。将需要处理的img节点作为参数，调用tempImg函数，克隆一个节点强行插在img之前，用于loading中的展示。 123456789101112var tempImg = function(target)&#123; var w = target.width(); var h = target.height(); var tempDom = target.clone().addClass(\"lazy-loding\").insertBefore(target); if(w/h == 1)&#123; tempDom[0].src = \"http://9.url.cn/edu/img/img-loading.png\"; &#125;else&#123; tempDom[0].src = \"http://9.url.cn/edu/img/img-loading2.png\"; &#125; target.hide();&#125; ###第三步：上报监控 这一步在大型前端项目中非常重要，也是经常被忽略的地方。尽管需要简易的后台配合，但不算麻烦的上报监控，能让产品更加稳定和健壮。 我在两个地方用到了上报。其一是图片加载失败，触发onerror时，这样一来我们能知道每天图片拉取失败的量；其二是图片加载的时间，能够帮助我们分析cdn服务是否异常，分析全国慢速用户比例等等。 而所谓的上报其实就是一个http请求，我会大概把这些信息带上 123456 log(&#123; 'type': 'error', 'msg': 'lazyload拉取图片失败上报 ', 'url': window.location.href, 'pid': 414342 //产品对应的id&#125;); ###第四步：居中截取 这是前端无可避免的一个问题，先来说下此问题的背景。 由于我们是先用一个空白的img标签占位，再去加载图片，如果图片的高度特别长（比如新浪长微博），加载完成时就会撑开节点，引起滚动条的跳动。由于移动端屏幕较PC窄，一个跳动就可能让你找不到前一秒正在浏览的内容，这种体验尤其严重。在移动端的web设计中，可以看到许多知名互联网公司的产品，也经常忽略这一点。 因此我们可以限定占位区域的size，以此区域来做居中截取。当占位区域与图片最终展示同宽同高时，就不会引起跳动，而且也保持了视觉的一致性。 其原理如下，先判断是竖向长型图，还是横向长型图，根据不同的情况，优先让宽或高填充满占位区域，然后通过不同的负margin去实现居中。 123456789101112131415var calSize = function($img) &#123; var w = $img.width(), h = $img.height(), width = size[0], height = size[1]; if(w+h == 0) return; //如果是长型图，优先适配宽度，高度居中截取 if(w/h &gt; width/height)&#123; var newWidth = height * w / h; var margin = (width - newWidth)/2; $img.height(height).css(&#123;\"margin-left\": margin&#125;); &#125;else&#123; var newHeight = width * h / w; var margin = (height - newHeight)/2; $img.width(width).css(&#123;\"margin-top\": margin&#125;); &#125;&#125; ###第五步：支持webp webp格式图片是google开发的一种旨在加快图片加载速度的图片格式，压缩提交大概只有jpg的2/3。随chrome的比例越来越多，其实让更多用户体验到webp也是一件好事。 那么问题来了，怎么去判断用户的浏览器是否支持webp呢？根据ua去判断是个好方法，但不太靠谱，因为chrome中其实也有设置，让它不能去支持webp，而且webkit本身就开源，会衍生出很多你不知道名字的浏览器。 最终我使用的是特性检测： 12345678910111213141516if(!supportedWebPIsLoading) &#123; supportedWebPIsLoading = true; var images = &#123; basic: \"data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA==\" &#125;, $img = new Image(); $img.onload = function () &#123; supportedWebPIsLoading = false; $.cookie.set(\"iswebp\" , +supportedWebP); &#125;; $img.onerror = function () &#123; supportedWebP = false; supportedWebPIsLoading = false; $.cookie.set(\"iswebp\" , +supportedWebP); &#125;; $img.src = images.basic;&#125; 我们会让浏览器试着加载一张非常小的base64格式的webp图片，如果能够正常加载，说明是支持webp的。 并且，会把测试记录在cookie里，所以第二次直接从cookie里读结果，基本不会影响性能。完成了最重要的检查，我们就可以放心让服务器返回不同格式的图片了。 End.","tags":[{"name":"js","slug":"js","permalink":"http://yumaster.net/tags/js/"}]},{"title":"绣春刀·修罗战场","date":"2017-07-21T04:55:00.000Z","path":"2017/07/21/diary-2017-0721/","text":"你笑了，你笑了，你也笑了。 我相信我自己。我相信这种世道不会长久。 从此，我用一把刀护你周全，你用一支笔绘我平安。 我们等爱聚散，只求清欢。 置信的孤与胆，皆成道。 生在这世道，当真没得选，可若是，活着只为了活着，这样的活法我绝不能忍受。 这样的世道，你还没过够吗？ 为你胜了战，为战失了算 换你安 ，这一蓑烟雨，这一生回忆，浓情淡如你。 这是一个什么样的世道，我们要换个活法， —— 07.21","tags":[{"name":"旧事","slug":"旧事","permalink":"http://yumaster.net/tags/旧事/"}]},{"title":"把自己锁在杯子里","date":"2017-07-16T04:50:00.000Z","path":"2017/07/16/lock-me-in-a-cup/","text":"杯子里的一条鱼你可担心会有天外扑来的龙卷风把你的魂魄摄出领地？泳池温热，心脏被灌了风，开垦者默言而卧涛声隐隐作痛若是一壶热酒浇下，由西向东你是缱绻醉倒？还是鱼跃入梦？ —— 07.16","tags":[{"name":"旧事","slug":"旧事","permalink":"http://yumaster.net/tags/旧事/"},{"name":"药别停","slug":"药别停","permalink":"http://yumaster.net/tags/药别停/"}]},{"title":"IT圈装逼速成指南","date":"2017-07-09T14:50:00.000Z","path":"2017/07/09/guide-for-zb/","text":"我有个朋友，春节回来时大家聚在一起，说自己买了iphone6但总觉得自己还是很low，问这是怎么回事？其实生活过得怎样，跟iphone是两码事。先把生活过得充实了，切莫本末倒置。当然，我们可以就“IT圈如何愉快的装X”敞开心扉谈下这个问题。以下几点仅供参考，实践时请注意预防雷劈。 ##谈资类 1、谈乔纳森。苹果设计师乔纳森。你要往死里黑他，但一定请记住，得是爱到深处自然黑那种黑。顺手拿过iphone6当惊堂木一拍（兄弟你得狠下这个心），当小伙伴因震惊不解而望着你时，你微微一笑，缓缓叹气：“彩虹山上的渐变爵士，身上却流着极简的血液…” 2、谈亚马逊。要坚定保持亚马逊没啥黑点的观点不动摇。当别人说到界面和UI时，你整个人都要散发出一种“亚马逊的产品很牛的所以界面什么的并不重要”的气质。 3、谈阿里IPO。这个话题面前，谈什么都会很low。但你可以很随意的说：哈哈，现场wifi信号一定很强！小伙伴们细细一品，就没人敢说话了。恰恰是这句随意的话，突显了你对整个路演格局的了然于胸！300名销售人员，主场和分场，等电梯要半小时，队伍有十八个弯…这些信息量都涵盖在这句话里了。 ##话题类 1、关于APP。[ˈæp] 念阿破（与爱破也比较像，参见音标），不能把三个字母拆开念成A P P。总的来说有三大注意事项：1、国内的，不玩。2、流行的，不玩。3、名声响的，不玩。 2、关于手机贴膜。营造出一种“一个批判者的自我愤怒”的气氛，让人感觉你在贴与不贴之间，一定有一段不可言说的故事。然后表现出自己已超脱了挣扎，在自己这个level，跟大家再讨论现实问题已毫无意义。因而你只好微笑着说：“你们不觉得让屏幕随手机一起慢慢变老，是一件很浪漫的事情吗？” 3、关于朋友圈。A：怎么很少见你发朋友圈？你：哦…国内的sns（一定要秀个英文）不太有意思，我回头把我ins帐号发你。当然你的朋友圈里还是可以写些东西，参考文字：脑残粉了一回，终于遇到了Trip Hawkins，从Spore开始就已喜欢上了EA… 4、关于BAT。不谈。 ##技巧类 1、欲扬先抑。在赞美目标的之前，把同类产品先夸一遍。不经意间，透露出自己知识面广，却又别有追求。具体句式可参考《中国好声音》：“杨坤老师，我一直很喜欢你，但是…” 2、回答问题。使用知乎文风，可助你吹的牛逼鹏翔万里，栩栩如生。有人会问，什么是知乎文风，难学吗？不难，记住两个词就可以了。第一个词在最开头用，“谢邀”。不管有没有人邀你，这主要是营造“我不是一个人在战斗”的氛围，以及一种“我本沉默奈何盛情难却”的傲娇。第二个词在最末尾用，“以上”。不管你以上的内容怎样，就这么一个词，有种老子发言结束了，你们该鼓掌的鼓掌该献花的献花的微妙情怀。 以上。","tags":[{"name":"旧事","slug":"旧事","permalink":"http://yumaster.net/tags/旧事/"},{"name":"生活","slug":"生活","permalink":"http://yumaster.net/tags/生活/"}]},{"title":"旧事 荔枝永远红不了 10.16-10.22","date":"2017-07-07T02:36:00.000Z","path":"2017/07/07/diary-2017-0707/","text":"这只猫，是我在公园认识的。一年前它还很小，每天穿行于古旧的荔枝林。傍晚我习惯到公园跑步，总能在固定的地点，看到阳光把它拉成巨大猛兽的情景。然而它更喜欢阴影。 第一次碰到它，他就躲在阴影里。因为是在车底，给它起了个名字叫阿杜…（逻辑满分，拒绝吐槽） 阿杜起先很怕人。我一走近，它就跳到树丛里，又好奇地瞪大眼珠往外看。外面的世界很精彩呀，但也可能很危险。这可能是它的信条。然而，在偶然喂过它几回后，它就单方面宣布和我友好了…猫以食为天，信条是什么？可以吃吗？ 但我只是个过客，阿杜的流浪生活还得继续。并且，这不意味着自由。第一，它每个傍晚都要回到公园，因为这里才有游人吃剩的食物；第二，跟其他小猫不一样，它居然不会爬树！ 所以，阿杜对树上的荔枝很感兴趣。在它的视角，可能那是会日渐变大的玩具球吧。有次我在树下的石凳上看书，是《树上的男爵》想到柯西莫倔强地在树上度过一生，阿杜却学不会爬树，这真是个有趣的玩笑。回过头来，它一动不动地伸长脖子，正瞪着眼睛往上看。空气里漂浮着明媚的尘埃，它的眼睛里好似藏了个宇宙。 想什么呢？谁知道。反正够不着，像星星。 但不能上树的猫，和在树上不下来的柯西莫才能简单明亮，最复杂的，是站在地上，又能够着“荔枝”的这个世界。熟了的苹果，掉下来，砸了牛顿的头。阿杜却永远等不到荔枝掉下来的那天。 因为，后来发生一件事，说有流浪猫死在树下，也有小孩子经过荔枝林时头晕。大家都说是荔枝喷了农药。又有公园的工作者出来“澄清”，说没有喷洒农药。真真假假，早已说不清。我只记得，期待了一季的荔枝，在6月将要变红的那几天，被人一扫而空。因为你要快人一步，才能占得先机，迟了一天，荔枝就到别人口袋了。得到了，就可以，青涩的果实？无所谓。 外面的世界好精彩… 这个小小的生灵，用这双眼眸，观望着它不能理解的世界。这是不幸，也是幸；它躲在阴影里，也站在了太阳下。那就继续期待吧阿杜。在来年。","tags":[{"name":"旧事","slug":"旧事","permalink":"http://yumaster.net/tags/旧事/"}]},{"title":"用不着洒脱，才是最大的洒脱","date":"2017-07-05T05:37:00.000Z","path":"2017/07/05/diary-2017-0705/","text":"我喜欢那种，经行语言（而不是光影）就能渲染出来的，边陲小镇特有的青翠与市侩。 人们总是要用“说走就走”来标榜旅行，貌似有了它，才多了一份洒脱。但于我说，这样经常是迫不得已，如果能够，我喜欢一个词，叫“蓄谋已久”。 我可以精心准备，旅行如约而至。仿佛是一位尊贵的客人，出现在那个预期的，天朗气清的时分。这说明，你的生活总掌握在自己的手里。 用不着洒脱，才是最大的洒脱。","tags":[{"name":"旧事","slug":"旧事","permalink":"http://yumaster.net/tags/旧事/"}]},{"title":"Hello World","date":"2017-06-30T17:39:00.000Z","path":"2017/07/01/hello-world/","text":"在两天的折腾下，这个博客终于搭建起来了。 折腾了两天多，看到自己的博客加载下来时，突然有种错综复杂的恍惚感。是的，它不是qq空间，不是新浪博客，不是豆瓣小站，也不是贴吧。它更像是属于自己的一块小小的领地，因而我满足于这种归属感。我愿在上面安静劳作。 一个农民，通过自身努力终于分到了一块地，不再需要在地主的土地上创造流量价值时，于是翻身作主的他可以宣告说：Hello World。当然这个农民确切来说是个码农。 我很喜欢这种色调。","tags":[{"name":"杂谈","slug":"杂谈","permalink":"http://yumaster.net/tags/杂谈/"}]}]